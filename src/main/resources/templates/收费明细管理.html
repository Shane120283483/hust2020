<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	    <link rel="stylesheet" href="css/table.css"/>
    <!-- 引入element样式 -->
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/element.css"/>
</head>
<body>
<div id="app">
    <template>
        <div style="height: 100%;">
            <el-date-picker type="month" placeholder="选择月份" v-model="dataDate" style="width: 320px" value-format="yyyy-MM-dd" @change="loadData"></el-date-picker>
            <el-button type="primary" @click="refresh" plain>点击刷新</el-button>
            <el-table id="table" ref="table" :data="tableData" style="margin-top: 10px; width: fit-content;" border >
                <!-- <el-table-column type="selection" width="40px"></el-table-column> -->
                <el-table-column prop="id" label="ID" width="50px"></el-table-column>
                <el-table-column prop="address" label="房屋地址" width="200px"></el-table-column>
                <el-table-column prop="electricityFee" label="电费" width="100px"></el-table-column>
                <el-table-column prop="waterFee" label="水费" width="100px"></el-table-column>
                <el-table-column prop="gasFee" label="煤气费" width="100px"></el-table-column>
                <el-table-column prop="money" label="应收金额" width="100px"></el-table-column>
                <el-table-column prop="operation" label="操作" width="120px">
                    <template slot-scope="scope">
                        <el-button size="mini" type="danger"  :disabled="scope.row.operation != '支付'" @click="pay(scope.row)">
                            {{scope.row.operation}}
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
    </template>
</div>
</body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/element-ui@2.13.2/lib/index.js"></script>
<script src="https://code.jquery.com/jquery-1.8.3.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
<script src="js/jquery.cookie.js" type="text/javascript"></script>
<script src="js/my.js" type="text/javascript"></script>
<script th:inline="javascript">
    var app = new Vue({
        el: '#app',
        data() {
            return {
                tableData: [],
                dialogVisible: false,
                dataDate: '',
            }
        },
        methods: {
            refresh(){
                location.reload();
            },
            pay(row) {
                var info = $.cookie('LoginInfo');
                if (!info) {
                    alert('请先登录！');
                    return;
                }
                var loginInfo = JSON.parse(info);
                var account = loginInfo.account;
                var token = loginInfo.token;
                let tp = this;
                $.post({
                    contentType: "application/json;charset=UTF-8",
                    url: "/" + "房产账户管理" + "/pay?account=" + account + "&token=" + token,
                    data: JSON.stringify({target: row.id, key: row.id + ' ' + tp.dataDate, change: row.money}),
                    success: function(ret) {
                        var tar = JSON.parse(ret);
                        if (tar.return_val === 0) {
                            tp.loadData(tp.dataDate);
                        } else {
                            alert(tar.info);
                        }
                    },
                    error: function(ret) {
                        alert('请求失败，请稍后再试');
                    }
                });
            },
            loadData(val) {
                dataDate = val;

                var info = $.cookie('LoginInfo');
                if (!info) {
                    alert('请先登录！');
                    return;
                }
                var loginInfo = JSON.parse(info);
                var account = loginInfo.account;
                var token = loginInfo.token;
                let tp = this;
                $.get({
                    contentType: "application/json;charset=UTF-8",
                    url: "/" + "收费明细管理" + "/get?account=" + account + "&token=" + token + "&date=" + dataDate,
                    success: function(ret) {
                        var tar = JSON.parse(ret);
                        if (tar.return_val === 0) {
                            tp.tableData = JSON.parse(tar.info);
                        } else {
                            alert(tar.info);
                        }
                    },
                    error: function(ret) {
                        alert('请求失败，请稍后再试');
                    }
                });
            },
            deleteItem(moduleName) {
                var info = $.cookie('LoginInfo');
                if (!info) {
                    alert('请先登录！');
                    return;
                }
                var loginInfo = JSON.parse(info);
                var account = loginInfo.account;
                var token = loginInfo.token;

                var dat = this.$refs.table.selection;
                if (!dat.length) return;
                var target_id = [];
                dat.forEach(i => {
                    target_id.push(i.id);
            });
                $.post({
                    contentType: "application/json;charset=UTF-8",
                    url: "/" + moduleName + "/delete?account=" + account + "&token=" + token,
                    data: JSON.stringify(target_id),
                    success: function(ret) {
                        var tar = JSON.parse(ret);
                        if (tar.return_val === 0) {
                            location.reload();
                        } else {
                            alert(tar.info);
                        }
                    },
                    error: function(ret) {
                        alert('请求失败，请稍后再试');
                    }
                });
            }
        }
    });
</script>
</html>